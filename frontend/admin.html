<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vestara - Admin Panel</title>
    <style>
    /* ---------------------------------- */
    /* GLOBAL & BODY STYLES */
    /* ---------------------------------- */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #eef2f7; /* Slightly darker light gray background */
        padding: 30px 20px;
        color: #444;
    }

    h1 {
        color: #004d99; /* Deep blue for titles */
        margin-bottom: 20px;
        border-bottom: 3px solid #007bff; /* Primary brand color underline */
        padding-bottom: 10px;
        display: inline-block;
    }

    /* ---------------------------------- */
    /* TABLE CONTAINER & SCROLLING */
    /* ---------------------------------- */
    .table-container { 
        overflow-x: auto; /* Allows horizontal scrolling for wide tables */
        margin-top: 20px;
        border-radius: 8px; /* Soft rounding */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
    }

    table { 
        width: 100%;
        min-width: 1600px; /* Forces scroll for demonstration */
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden; /* Ensures rounded corners apply to content */
    }

    /* ---------------------------------- */
    /* TABLE HEADERS */
    /* ---------------------------------- */
    th {
        background-color: #007bff; /* Your primary brand blue */
        color: white;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600; /* Slightly bolder font */
        text-transform: uppercase;
        font-size: 0.85em;
    }

    /* ---------------------------------- */
    /* TABLE DATA & ROWS */
    /* ---------------------------------- */
    td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0; /* Lighter divider lines */
        font-size: 0.9em;
    }

    tr:nth-child(even) {
        background-color: #f8f8f8; /* Light striping for readability */
    }
    
    tr:hover {
        background-color: #e6f7ff; /* Lighter blue hover effect */
    }

    /* ---------------------------------- */
    /* BUTTONS */
    /* ---------------------------------- */
    button {
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s ease;
        font-weight: 500;
    }
    
    .btn-delete {
        background-color: #ff4d4d; /* Red for delete */
        color: white;
    }
    
    .btn-delete:hover {
        background-color: #cc0000;
    }

    .btn-refresh {
        background-color: #6c757d; /* Gray for refresh */
        color: white;
        margin-right: 10px;
    }

    .btn-refresh:hover {
        background-color: #5a6268;
    }

    .btn-download {
        background-color: #28a745; /* Green for download */
        color: white;
    }

    .btn-download:hover {
        background-color: #1e7e34;
    }

</style>
</head>
<body>

    <h1>ðŸ“¦ Order Management Dashboard</h1>
<p>Real-time view of customer orders. 
    <button onclick="loadOrders()" class="btn-refresh">Refresh</button>
    <button onclick="exportToExcel()" class="btn-download">Download Orders (Excel)</button>
</p>
    <div class="table-container">

    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Address</th>
                <th>City</th>
                <th>State</th>
                <th>Zip Code</th>
                <th>Country</th>
                <th>Product Name</th>
                <th>Qty</th>
                <th>Total Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="orderTable">
            <tr><td colspan="13">Loading orders...</td></tr>
        </tbody>
    </table>

   <script>
    const API_URL = "http://localhost:5000";
    let allOrders = []; // Global variable to store data for export

    // 1. Fetch and Display Orders (Updated for Dynamic Cart)
    async function loadOrders() {
        try {
            const response = await fetch(`${API_URL}/orders`);
            allOrders = await response.json(); // Store fetched data globally
            
            const tableBody = document.getElementById("orderTable");
            tableBody.innerHTML = ""; // Clear existing data

            if (allOrders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13">No orders found. Place an order via checkout.html to see data.</td></tr>';
                return;
            }

            allOrders.forEach(order => {
                const date = new Date(order.createdAt).toLocaleDateString();
                
                // --- Customer Details (Nested) ---
                const customer = order.customer || {};
                const customerName = customer.name || "N/A";
                const customerEmail = customer.email || "N/A";
                // Now correctly reading from the nested 'customer' object:
                const customerPhone = customer.phone || "N/A"; 
                const customerAddress = customer.street || "N/A";
                const customerCity = customer.city || "N/A";
                const customerState = customer.state || "N/A";
                const customerZip = customer.zipCode || "N/A";
                const customerCountry = customer.country || "N/A";

                // --- Dynamic Product Display (for multiple items) ---
                const productsList = order.products || [];
                
                // Generate HTML to display all product names in one cell, separated by <br>
                const productName = productsList.map(p => 
                    `<span style="font-weight: 600;">${p.name || 'N/A'}</span>`
                ).join('<br>');
                
                // Generate HTML to display all quantities in one cell, separated by <br>
                const productQuantity = productsList.map(p => 
                    `${p.quantity || 0}`
                ).join('<br>');

                const total = order.totalAmount ? order.totalAmount.toFixed(2) : "0.00";
                
                // Ensure the colspan in the empty message (at the end) is 13
                const row = `
                    <tr>
                        <td>${date}</td>
                        <td>${customerName}</td>
                        <td>${customerEmail}</td>
                        <td>${customerPhone}</td>
                        <td>${customerAddress}</td>
                        <td>${customerCity}</td>
                        <td>${customerState}</td>
                        <td>${customerZip}</td>
                        <td>${customerCountry}</td>
                        <td>${productName}</td>
                        <td>${productQuantity}</td>
                        <td>RS. ${total}</td>
                        <td>
                            <button class="btn-delete" onclick="deleteOrder('${order._id}')">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        } catch (error) {
            document.getElementById("orderTable").innerHTML = '<tr><td colspan="13">Error fetching orders. Is the server running?</td></tr>';
            console.error("Error loading orders:", error);
        }
    }

    // 2. Excel Export Function (Summarizes multiple items into one cell per column)
    function exportToExcel() {
        if (allOrders.length === 0) {
            alert("No orders to download!");
            return;
        }

        // Define column headers
        let csvContent = "Date,Name,Email,Phone,Address,City,State,Zip Code,Country,Product Name(s),Quantity(s),Total Price\n";

        allOrders.forEach(order => {
            const date = new Date(order.createdAt).toLocaleDateString();
            
            // Safely extract nested data
            const customer = order.customer || {};
            const productsList = order.products || [];
            
            // Summarize products for CSV columns
            const productName = productsList.map(p => `${p.name} (x${p.quantity})`).join('; ');
            const quantity = productsList.reduce((sum, p) => sum + (p.quantity || 0), 0); // Sum all quantities
            
            const name = customer.name || "";
            const email = customer.email || "";
            const phone = customer.phone || ""; 
            const address = customer.street || "";
            const city = customer.city || "";
            const state = customer.state || "";
            const zipCode = customer.zipCode || "";
            const country = customer.country || "";
            const total = order.totalAmount ? order.totalAmount.toFixed(2) : "0.00";

            // Create the CSV row. Using double quotes around strings that might contain commas.
            const row = `${date},"${name}","${email}",${phone},"${address} ${city} ${state} ${zipCode} ${country}","${city}","${state}",${zipCode},"${country}","${productName}",${quantity},${total}\n`;
            csvContent += row;
        });

        // Create a Blob and trigger the download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        
        link.setAttribute("href", url);
        link.setAttribute("download", `Vestara_Orders_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 3. Delete Order Function
    async function deleteOrder(id) {
        if(!confirm("Are you sure you want to delete order " + id + "?")) return;

        const res = await fetch(`${API_URL}/order/${id}`, { method: "DELETE" });
        const data = await res.json();

        if (data.success) {
            console.log("Order removed:", id);
            loadOrders(); // Refresh the table
        } else {
            alert("Error deleting order");
        }
    }

    // Load orders when page opens
    loadOrders();
</script>

</body>
</html>