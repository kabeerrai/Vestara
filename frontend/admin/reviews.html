<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vestara Admin - Reviews</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Vestara Admin</h2>
                <p id="adminEmail"></p>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span class="icon">üìä</span> Dashboard
                </a>
                <a href="products.html" class="nav-item">
                    <span class="icon">üì¶</span> Products
                </a>
                <a href="orders.html" class="nav-item">
                    <span class="icon">üõí</span> Orders
                </a>
                <a href="reviews.html" class="nav-item active">
                    <span class="icon">‚≠ê</span> Reviews
                </a>
            </nav>
            <div class="sidebar-footer">
                <button onclick="logout()" class="btn-secondary">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h1>Reviews</h1>
                <button onclick="loadReviews()" class="btn-secondary">Refresh</button>
            </header>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Rating</th>
                            <th>Review</th>
                            <th>Product ID</th>
                            <th>Date</th>
                            <th>Visibility</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsTable">
                        <tr><td colspan="7">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="admin.js"></script>
    <script>
        checkAuth();
        loadReviews();

        async function loadReviews() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/api/admin/reviews`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                
                if (data.success) {
                    const reviews = data.reviews;
                    const tableHTML = reviews.length > 0
                        ? reviews.map(review => {
                            const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
                            return `
                                <tr class="${review.visible ? '' : 'review-hidden'}">
                                    <td><strong>${review.name}</strong></td>
                                    <td><span class="rating-stars">${stars}</span> (${review.rating})</td>
                                    <td class="review-text">${review.review}</td>
                                    <td>${review.productId || 'General'}</td>
                                    <td>${new Date(review.createdAt).toLocaleDateString()}</td>
                                    <td>
                                        <span class="badge ${review.visible ? 'badge-success' : 'badge-error'}">
                                            ${review.visible ? 'Visible' : 'Hidden'}
                                        </span>
                                    </td>
                                    <td>
                                        <button 
                                            onclick="toggleReviewVisibility('${review._id}')" 
                                            class="btn-small ${review.visible ? 'btn-warning' : 'btn-success'}"
                                        >
                                            ${review.visible ? 'Hide' : 'Show'}
                                        </button>
                                        <button onclick="deleteReview('${review._id}')" class="btn-small btn-danger">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')
                        : '<tr><td colspan="7">No reviews found</td></tr>';
                    
                    document.getElementById('reviewsTable').innerHTML = tableHTML;
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                showNotification('Failed to load reviews', 'error');
            }
        }

        async function toggleReviewVisibility(id) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/api/admin/reviews/${id}/toggle`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification('Review visibility updated');
                    loadReviews();
                } else {
                    showNotification('Failed to update review', 'error');
                }
            } catch (error) {
                console.error('Error toggling review:', error);
                showNotification('Failed to update review', 'error');
            }
        }

        async function deleteReview(id) {
            if (!confirm('Are you sure you want to delete this review?')) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/api/admin/reviews/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification('Review deleted successfully');
                    loadReviews();
                } else {
                    showNotification('Failed to delete review', 'error');
                }
            } catch (error) {
                console.error('Error deleting review:', error);
                showNotification('Failed to delete review', 'error');
            }
        }
    </script>
</body>
</html>